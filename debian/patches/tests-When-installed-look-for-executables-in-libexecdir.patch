From: Simon McVittie <smcv@debian.org>
Date: Sun, 22 Dec 2019 22:18:13 +0000
Subject: tests: When installed, look for executables in libexecdir

They won't normally be in the PATH when installed.

Signed-off-by: Simon McVittie <smcv@debian.org>
---
 tests/Makefile.am.inc |  2 ++
 tests/test-portals.c  | 18 ++++++++++++++----
 2 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/tests/Makefile.am.inc b/tests/Makefile.am.inc
index 27acc5d..7054ed7 100644
--- a/tests/Makefile.am.inc
+++ b/tests/Makefile.am.inc
@@ -2,6 +2,7 @@ test_programs =
 
 TESTS_ENVIRONMENT = \
 	PATH=$$(cd $(top_builddir) && pwd):$${PATH} \
+	XDP_UNINSTALLED=1 \
 	$(NULL)
 
 testdb_CFLAGS = $(AM_CFLAGS) $(BASE_CFLAGS) -I$(srcdir)/document-portal -I$(builddir)/document-portal -I$(builddir)/
@@ -29,6 +30,7 @@ test_portals_LDADD = \
 	$(LIBPORTAL_LIBS) \
 	$(NULL)
 test_portals_SOURCES = tests/test-portals.c
+test_portals_CPPFLAGS = $(AM_CPPFLAGS) -DLIBEXECDIR=\"$(libexecdir)\"
 if HAVE_LIBPORTAL
 test_portals_CFLAGS += $(LIBPORTAL_CFLAGS)
 test_portals_LDADD += $(LIBPORTAL_LIBS)
diff --git a/tests/test-portals.c b/tests/test-portals.c
index c2db1ea..d3dd858 100644
--- a/tests/test-portals.c
+++ b/tests/test-portals.c
@@ -156,8 +156,13 @@ global_setup (void)
   g_subprocess_launcher_setenv (launcher, "XDG_DESKTOP_PORTAL_DIR", portal_dir, TRUE);
   g_subprocess_launcher_setenv (launcher, "XDG_DATA_HOME", outdir, TRUE);
   g_subprocess_launcher_setenv (launcher, "PATH", g_getenv ("PATH"), TRUE);
- 
-  argv[0] = "xdg-desktop-portal";
+
+  /* When running uninstalled we rely on this being added to PATH */
+  if (g_getenv ("XDP_UNINSTALLED") != NULL)
+    argv[0] = "xdg-desktop-portal";
+  else
+    argv[0] = LIBEXECDIR "/xdg-desktop-portal";
+
   argv[1] = g_test_verbose () ? "--verbose" : NULL;
   argv[2] = NULL;
 
@@ -190,8 +195,13 @@ global_setup (void)
   g_subprocess_launcher_setenv (launcher, "DBUS_SESSION_BUS_ADDRESS", g_test_dbus_get_bus_address (dbus), TRUE);
   g_subprocess_launcher_setenv (launcher, "XDG_DATA_HOME", outdir, TRUE);
   g_subprocess_launcher_setenv (launcher, "PATH", g_getenv ("PATH"), TRUE);
- 
-  argv[0] = "xdg-permission-store";
+
+  /* When running uninstalled we rely on this being added to PATH */
+  if (g_getenv ("XDP_UNINSTALLED") != NULL)
+    argv[0] = "xdg-permission-store";
+  else
+    argv[0] = LIBEXECDIR "/xdg-permission-store";
+
   argv[1] = "--replace";
   argv[2] = g_test_verbose () ? "--verbose" : NULL;
   argv[3] = NULL;
